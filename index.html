<!-- Codigo escrito e revisado pelo Teacher Bruno do IAPE, por favor, replique com creditos ao IAPE!! 
Fiquem a vontade pra checar  codigo... -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iape - Agendamento de Espa√ßos</title>
  <meta name="theme-color" content="#0B1D39" />
  <!-- Performance: conex√£o antecipada com Apps Script pra ficar mais ligeirinho -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="//script.google.com">
  <!-- Favicons (alguns nao vao ser utilizados) -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#0B1D39">
  <meta name="msapplication-TileColor" content="#0B1D39">
  <style>
    :root{ --navy:#0B1D39; --ok:#16a34a; --muted:#cbd5e1; --danger:#ef4444; --bg:#000; --text:#e5e7eb; --card:#0b0b0b; --border:#1f2937; }
    body.light{ --bg:#fff; --text:#111827; --card:#f8fafc; --border:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer;border:none;font:inherit;background:transparent;color:var(--text)}
    input,textarea,select{font:inherit;color:inherit;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%}

    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(180%) blur(8px);background:color-mix(in hsl,var(--bg) 86%,transparent);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .logo{height:36px;animation:twinkle 2.6s ease-in-out infinite}
    @keyframes twinkle{0%,100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0)) brightness(1)}7%{filter:drop-shadow(0 0 8px rgba(255,255,255,.45)) brightness(1.14)}22%{filter:drop-shadow(0 0 10px rgba(255,255,255,.5)) brightness(1.18)}51%{filter:drop-shadow(0 0 7px rgba(255,255,255,.4)) brightness(1.12)}78%{filter:drop-shadow(0 0 9px rgba(255,255,255,.45)) brightness(1.14)}}
    .title{font-weight:700}
    .grow{flex:1}
    .btn{background:var(--navy);color:#fff;border-radius:999px;padding:10px 16px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 16px rgba(11,29,57,0.25)}
    .icon-btn{border:1px solid var(--border);border-radius:12px;padding:8px 10px;display:inline-flex;align-items:center;justify-content:center}
    .icon{width:18px;height:18px;display:block}
    main{max-width:1100px;margin:0 auto;padding:18px 16px 90px}

    .grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{position:relative;border:1px solid var(--border);border-radius:18px;overflow:hidden;background:var(--card)}
   .card img{
  width:100%;
  aspect-ratio: 1 / 1;   /* altura = largura => quadrado */
  height:auto;           /* deixa o browser calcular pela raz√£o */
  object-fit:cover;      /* corta centralizado se a foto n√£o for quadrada */
  display:block;
}
    .card .name{position:absolute;left:10px;bottom:10px;padding:8px 12px;border-radius:999px;background:color-mix(in hsl,var(--bg) 65%,rgba(0,0,0,.5));border:1px solid var(--border);font-weight:700}

    .back{display:inline-flex;align-items:center;gap:8px;margin-bottom:10px}
    .space-hero{display:grid;gap:12px;grid-template-columns:120px 1fr;align-items:center}
    .space-hero img{width:120px;height:80px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
    .space-hero .nm{font-size:1.25rem;font-weight:800}

    .calendar{margin-top:14px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--card)}
    .cal-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border)}
    .cal-nav{display:flex;gap:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}
    .dow{font-size:12px;color:#94a3b8;text-transform:uppercase;letter-spacing:.04em}
    .cell{aspect-ratio:1/1;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border);user-select:none}
    .cell.free{background:color-mix(in hsl,var(--ok) 18%,transparent);color:#10b981;border-style:dashed}
    .cell.busy{background:#2b2f36;color:#94a3b8}
    body.light .cell.busy{background:#e5e7eb;color:#475569}
    .cell.dim{opacity:.45}
    .cell.clickable{cursor:pointer}

    .legend{display:flex;gap:10px;align-items:center;padding:8px 12px 14px}
    .dot{width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
    .dot.free{background:color-mix(in hsl,var(--ok) 40%,transparent)}
    .dot.busy{background:#2b2f36}
    body.light .dot.busy{background:#e5e7eb}

    .list{margin-top:14px;border:1px solid var(--border);border-radius:16px;background:var(--card);overflow:hidden}
    .list h3{margin:0;padding:12px;border-bottom:1px solid var(--border)}
    .row{display:grid;grid-template-columns:180px 1fr;gap:8px;padding:12px;border-top:1px dashed var(--border)}
    /* Zebra nas linhas da lista */
    #reservationsBody .row:nth-child(even){ background:#111827; }
    body.light #reservationsBody .row:nth-child(even){ background:#eef2f7; }

    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f172a;color:#cbd5e1;border:1px solid var(--border);font-size:13px}
    body.light .badge{background:#f1f5f9;color:#334155}
    /* Destaque pro dia de HOJE (pra ficar mais visual pros teachers */
    .badge.today{ background: var(--ok); color:#fff; border-color: color-mix(in hsl, var(--ok) 55%, var(--border)); font-weight:800; }

    .empty{padding:12px;color:#94a3b8}

    /* bot√£o de imprimir o relatorio em pdf */
    .print-wrap{display:flex;justify-content:center;padding:16px 0 4px}

    /* MODAL */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:60;padding:12px;overflow:auto}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:760px;max-height:calc(100dvh - 24px);display:flex;flex-direction:column;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:auto;-webkit-overflow-scrolling:touch}
    .sheet header{position:sticky;top:0;z-index:1;background:var(--card);border-bottom:1px solid var(--border)}
    .sheet .wrap{padding:14px}
    .sheet .content{flex:1 1 auto;min-height:0;padding:14px;display:grid;gap:10px;overflow:visible}
    .sheet .actions{position:sticky;bottom:0;z-index:1;background:var(--card);padding:12px 14px calc(16px + env(safe-area-inset-bottom, 0px));display:flex;gap:10px;justify-content:space-between;align-items:center;border-top:1px solid var(--border)}
    .danger{color:var(--danger)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0a0a0a;color:#e5e7eb;padding:10px 14px;border-radius:999px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.5);display:none;z-index:70}
    body.light .toast{background:#111827}

    .slot-list{display:grid;gap:8px}
    .slot-item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--card)}
    .slot-free{border-style:dashed;box-shadow:inset 0 0 0 1px rgba(22,163,74,.15)}
    .slot-txt{font-weight:600}
    .slot-sub{font-size:12px;color:#94a3b8}
    .slot-btn{padding:8px 12px;border-radius:10px;background:var(--navy);color:#fff}
    .slot-btn.selected{background:var(--ok)}
    .slot-busy{opacity:.9}

    /* chips da parte da tarde */
    .af-grid{display:grid;gap:8px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:720px){.af-grid{grid-template-columns:repeat(3,1fr)}}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:10px;text-align:center}
    .chip.free{cursor:pointer}
    .chip.busy{opacity:.5}
    .chip.selected{outline:2px solid var(--navy); background:color-mix(in hsl,var(--navy) 10%, transparent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <img id="logo" class="logo" src="logo3.png" alt="IAPE" />
      <div class="title">Agendamento de Espa√ßos</div>
      <div class="grow"></div>
      <button id="themeToggle" class="btn" aria-label="Alternar tema">üåì</button>
    </div>
  </header>

  <main>
    <section id="home">
      <div class="grid" id="spaceGrid"></div>
    </section>

    <section id="spaceView" hidden>
      <a href="#" class="back">‚Üê Voltar</a>
      <div class="space-hero">
        <img id="spaceImg" alt="Capa do espa√ßo" />
        <div>
          <div id="spaceName" class="nm"></div>
          <div id="spaceSlug" style="font-size:12px;color:#94a3b8"></div>
        </div>
      </div>

      <div class="calendar" id="calendar"></div>

      <div class="list" id="reservationsList">
        <h3>Reservas do m√™s</h3>
        <div id="reservationsBody"></div>
      </div>
      <div class="print-wrap"><button id="printReportBtn" class="btn" type="button">üñ®Ô∏è Imprimir relat√≥rio</button></div>
    </section>
  </main>

  <!-- SLOTS DO DIA (multi-select) -->
  <div id="slotsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="slotsTitle">
    <div class="sheet">
      <header>
        <div class="wrap">
          <strong id="slotsTitle">Hor√°rios do dia</strong>
          <div class="grow"></div>
          <button class="icon-btn" id="closeSlots" aria-label="Fechar">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </header>
      <div class="content">
        <div id="slotsDateLabel" class="badge">Data: ‚Äî</div>
        <div>
          <h3 style="margin:8px 0 6px">Manh√£</h3>
          <div id="morningList" class="slot-list"></div>
        </div>
        <div>
          <h3 style="margin:12px 0 6px">Tarde (13:00‚Äì18:00) ‚Äî blocos de 30 min</h3>
          <div id="afGrid" class="af-grid"></div>
          <div id="afInfo" class="slot-sub" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="actions">
        <div id="selSummary" class="slot-sub">0 hor√°rio(s) selecionado(s)</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="clearSel" class="icon-btn" title="Limpar sele√ß√£o">Limpar</button>
          <button id="goReserve" class="btn" disabled>Reservar selecionados</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: nome + atividade (aplica em todos os horarios selecionados), pra ficar mais pratico -->
  <div id="reserveModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reserveTitle">
    <div class="sheet">
      <header>
        <div class="wrap">
          <strong id="reserveTitle">Confirmar reserva</strong>
          <div class="grow"></div>
          <button class="icon-btn" id="closeReserve" aria-label="Fechar">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </header>
      <div class="content">
        <div id="reserveMeta" class="badge">‚Äî</div>
        <label>Solicitante <input id="inpSolicitante" maxlength="80" placeholder="Seu nome" /></label>
        <label>Atividade <textarea id="inpAtividade" rows="3" maxlength="240" placeholder="Descreva a atividade"></textarea></label>
        <div id="reserveError" class="danger" style="display:none"></div>
      </div>
      <div class="actions">
        <div class="slot-sub" id="reserveCount">‚Äî</div>
        <button id="btnSalvar" class="btn">Salvar reservas</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ========= CONFIG ========= */
const API_BASE = "https://script.google.com/macros/s/AKfycbwuluA4Eyw_cYc1RGGNvOAwZrzxtaaLzprChsY5UDYDUoStI5wenVkXTQjIdPW_eaEn/exec"; // use o seu link mais recente
const AFTERNOON_START = "13:00";
const AFTERNOON_END   = "18:00"; // at√© as 18h (possivel ajuste 22:00, mas nao precisa por que nesse horario os diretores que usam)
const BLOCK_MIN      = 30;       // blocos de 30 min pra ser mais preciso nas reservas

const SPACES = [
  { name: "Sala Maker", slug: "sala-maker", img: "assets/sala-maker.png" },
  { name: "Sala de Recursos", slug: "sala-de-recursos", img: "assets/sala-recursos.png" },
  { name: "Laborat√≥rio", slug: "laboratorio", img: "assets/laboratorio.png" },
  { name: "E-Class", slug: "e-class", img: "assets/e-class.png" },
  { name: "Sal√£o de Jogos", slug: "salao-de-jogos", img: "assets/salao-jogos.png" },
  { name: "Casar√£o", slug: "casarao", img: "assets/casarao.png" },
  { name: "Fazendinha", slug: "fazendinha", img: "assets/fazendinha.png" },
  { name: "Audit√≥rio Feminino", slug: "auditorio-feminino", img: "assets/auditorio-feminino.png" },
  { name: "Audit√≥rio Central", slug: "auditorio-central", img: "assets/auditorio-central.png" },
];

const TIMESLOTS = {
  MON: [
    { id:"1", label:"1¬™ aula", start:"07:15", end:"08:00" },
    { id:"2", label:"2¬™ aula", start:"08:00", end:"08:45" },
    { id:"3", label:"3¬™ aula", start:"09:05", end:"09:50" },
    { id:"4", label:"4¬™ aula", start:"09:50", end:"10:35" },
    { id:"5", label:"5¬™ aula", start:"11:00", end:"11:40" },
    { id:"6", label:"6¬™ aula", start:"11:40", end:"12:20" },
    { id:"7", label:"7¬™ aula", start:"12:20", end:"13:00" }
  ],
  TUE: [], WED: [],
  THU: [
    { id:"1", label:"1¬™ aula", start:"07:15", end:"08:00" },
    { id:"2", label:"2¬™ aula", start:"08:00", end:"08:45" },
    { id:"3", label:"3¬™ aula", start:"09:05", end:"09:50" },
    { id:"4", label:"4¬™ aula", start:"09:50", end:"10:35" },
    { id:"5", label:"5¬™ aula", start:"10:35", end:"11:20" },
    { id:"6", label:"6¬™ aula", start:"11:20", end:"12:05" },
    { id:"7", label:"7¬™ aula", start:"12:05", end:"12:50" }
  ],
  FRI: [
    { id:"1", label:"1¬™ aula", start:"07:15", end:"08:00" },
    { id:"2", label:"2¬™ aula", start:"08:00", end:"08:45" },
    { id:"3", label:"3¬™ aula", start:"09:05", end:"09:50" },
    { id:"4", label:"4¬™ aula", start:"09:50", end:"10:35" },
    { id:"5", label:"5¬™ aula", start:"10:35", end:"11:20" },
    { id:"6", label:"6¬™ aula", start:"11:20", end:"12:05" },
    { id:"7", label:"7¬™ aula", start:"12:05", end:"12:50" }
  ],
  SAT: [], SUN: []
};
['TUE','WED','SAT','SUN'].forEach(k=>{ if(!TIMESLOTS[k]?.length) TIMESLOTS[k] = TIMESLOTS.MON.map(s=>({...s})); });

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const state = { route:{page:'home',space:null}, month:new Date(), reservations:[], selectedDay:null, selections:[] };
const RES_CACHE = new Map(); // cache por espa√ßo+m√™s (SWR), pra ficar mais ligeiro aqui tambem...

function fmtDateISO(d){ return d.toISOString().slice(0,10); }
function fmtBR(iso){ return new Date(iso+"T00:00:00").toLocaleDateString('pt-BR',{timeZone:'America/Recife'}); }
function todayISO(){ return new Intl.DateTimeFormat('en-CA',{timeZone:'America/Recife',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
function dayKey(iso){ return ['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date(iso+"T00:00:00").getDay()]; }
function slotsForDate(iso){ const key = dayKey(iso); return (TIMESLOTS[key]||[]).map(s=>({...s, slotKey:`${s.start}-${s.end}`})); }
function parseMin(hhmm){ const [h,m]=String(hhmm).split(':').map(Number); return (isFinite(h)&&isFinite(m)) ? h*60+m : 0; }
function minToHHMM(n){ const h=String(Math.floor(n/60)).padStart(2,'0'); const m=String(n%60).padStart(2,'0'); return `${h}:${m}`; }
function intervalsOverlap(aS,aE,bS,bE){ return aS < bE && bS < aE; }
function updateLogoForTheme(){ const isLight = document.body.classList.contains('light'); const img = document.getElementById('logo'); img.src = isLight ? 'assets/logo.png' : 'logo3.png'; }
function setTheme(t){ if(t==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); localStorage.setItem('iape-theme',t); updateLogoForTheme(); }
(function(){ const saved=localStorage.getItem('iape-theme'); if(saved) setTheme(saved); else updateLogoForTheme(); })();
$('#themeToggle').addEventListener('click',()=> setTheme(document.body.classList.contains('light')?'dark':'light'));

/* ===== Cache helpers (SWR) ===== */
function monthKey(space, y, m){ return `${space}:${y}-${String(m).padStart(2,'0')}`; }
function getCached(space,y,m){ return RES_CACHE.get(monthKey(space,y,m)) || []; }
async function fetchAndCache(space,y,m){ const data = await apiList(space,y,m); RES_CACHE.set(monthKey(space,y,m), data); return data; }
function sameMonth(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }
async function swrUpdate(space,y,m){
  try{
    const fresh = await fetchAndCache(space,y,m);
    // s√≥ atualiza se ainda estamos olhando este espa√ßo/m√™s
    if(state.route.space===space && state.month.getFullYear()===y && (state.month.getMonth()+1)===m){
      state.reservations = fresh; renderCalendar(); renderList();
    }
  }catch(e){ /* silencia quando tem falha de rede */ }
}
function prefetchAdjacent(space,baseDate){
  const prev=new Date(baseDate.getFullYear(), baseDate.getMonth()-1, 1);
  const next=new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 1);
  const py=prev.getFullYear(), pm=prev.getMonth()+1, ny=next.getFullYear(), nm=next.getMonth()+1;
  if(!RES_CACHE.has(monthKey(space,py,pm))) fetchAndCache(space,py,pm).catch(()=>{});
  if(!RES_CACHE.has(monthKey(space,ny,nm))) fetchAndCache(space,ny,nm).catch(()=>{});
}

/* ===== Router ===== */
function goHome(){ state.route={page:'home',space:null}; render(); }
function goSpace(slug){
  state.route={page:'space',space:slug};
  state.month=new Date();
  // pinta imediatamente com cache (ou vazio) e atualiza em background
  const y=state.month.getFullYear(), m=state.month.getMonth()+1;
  state.reservations = getCached(slug,y,m);
  render(); // mostra j√° o calend√°rio
  swrUpdate(slug,y,m); // atualiza em 2¬∫ plano
  prefetchAdjacent(slug, state.month);
}
window.addEventListener('hashchange',()=>{ const h=new URLSearchParams(location.hash.slice(1)); h.get('space')?goSpace(h.get('space')):goHome(); });

/* ===== Home ===== */
function renderHome(){
  const grid=$('#spaceGrid'); grid.innerHTML='';
  SPACES.forEach(sp=>{
    const a=document.createElement('a'); a.href=`#space=${sp.slug}`; a.className='card';
    a.innerHTML=`<img src="${sp.img}" alt="${sp.name}" loading="lazy" decoding="async" onerror="this.src='https://picsum.photos/seed/${sp.slug}/800/450'"/><div class="name">${sp.name}</div>`;
    grid.appendChild(a);
  });
  $('#home').hidden=false; $('#spaceView').hidden=true;
}

/* ===== Calendar ===== */
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

function halfHourBlocks(){
  const s=parseMin(AFTERNOON_START), e=parseMin(AFTERNOON_END); const out=[];
  for(let t=s; t<e; t+=BLOCK_MIN){ out.push({ start:minToHHMM(t), end:minToHHMM(t+BLOCK_MIN) }); }
  return out;
}

function dayHasAvailability(iso){
  const slots=slotsForDate(iso);
  const takenKeys=new Set(state.reservations.filter(r=>r.date===iso && r.type==='slot').map(r=>r.slot_key));
  if (slots.some(s=>!takenKeys.has(s.slotKey))) return true;
  // tarde
  const blocks=halfHourBlocks();
  const todays=state.reservations.filter(r=>r.date===iso);
  return blocks.some(b=> !todays.some(r=> intervalsOverlap(parseMin(b.start),parseMin(b.end),parseMin(r.start),parseMin(r.end))));
}

function renderCalendar(){
  const wrap=$('#calendar'); wrap.innerHTML='';
  const month=state.month; const monthName=month.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const head=document.createElement('div'); head.className='cal-head';
  head.innerHTML=`
    <button class="icon-btn" id="prevM" aria-label="M√™s anterior">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div><strong>${monthName}</strong></div>
    <div class="cal-nav">
      <button class="icon-btn" id="todayBtn" aria-label="Hoje">Hoje</button>
      <button class="icon-btn" id="nextM" aria-label="Pr√≥ximo m√™s">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>`;
  wrap.appendChild(head);

  // Navega√ß√£o instant√¢nea + atualiza√ß√£o em background
  $('#prevM').addEventListener('click',()=>{
    const space=state.route.space; const m=state.month;
    state.month=new Date(m.getFullYear(),m.getMonth()-1,1);
    const y=state.month.getFullYear(), mo=state.month.getMonth()+1;
    state.reservations = getCached(space,y,mo);
    renderCalendar(); renderList();
    swrUpdate(space,y,mo); prefetchAdjacent(space, state.month);
  });
  $('#nextM').addEventListener('click',()=>{
    const space=state.route.space; const m=state.month;
    state.month=new Date(m.getFullYear(),m.getMonth()+1,1);
    const y=state.month.getFullYear(), mo=state.month.getMonth()+1;
    state.reservations = getCached(space,y,mo);
    renderCalendar(); renderList();
    swrUpdate(space,y,mo); prefetchAdjacent(space, state.month);
  });
  $('#todayBtn').addEventListener('click',()=>{
    const space=state.route.space; state.month=new Date();
    const y=state.month.getFullYear(), mo=state.month.getMonth()+1;
    state.reservations = getCached(space,y,mo);
    renderCalendar(); renderList();
    swrUpdate(space,y,mo); prefetchAdjacent(space, state.month);
  });

  const grid=document.createElement('div'); grid.className='cal-grid';
  ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'].forEach(d=>{ const el=document.createElement('div'); el.textContent=d; el.className='dow'; grid.appendChild(el); });

  const first=startOfMonth(month), last=endOfMonth(month);
  for(let i=0;i<first.getDay();i++){ const c=document.createElement('div'); c.className='cell dim'; grid.appendChild(c); }
  for(let d=1; d<=last.getDate(); d++){
    const date=new Date(month.getFullYear(), month.getMonth(), d); const iso=fmtDateISO(date);
    const free=dayHasAvailability(iso);
    const cell=document.createElement('div'); cell.className=`cell ${free?'free':'busy'} clickable`; cell.textContent=d;
    cell.addEventListener('click',()=> openSlotsModal(iso)); grid.appendChild(cell);
  }
  wrap.appendChild(grid);
  const legend=document.createElement('div'); legend.className='legend'; legend.innerHTML=`<span class="dot free"></span> H√° hor√°rios livres <span class="dot busy" style="margin-left:12px"></span> Sem disponibilidade`; wrap.appendChild(legend);
}

/* ===== Consolida√ß√£o para a lista mensal ===== */
function consolidateMonth(res){
  const byDate = {}; res.forEach(r=>{ (byDate[r.date] ||= []).push(r); });
  const merged = [];
  for (const [date, arr] of Object.entries(byDate)){
    const groups = {};
    arr.forEach(r=>{ const k = `${r.solicitante}\u0001${r.atividade}`; (groups[k] ||= []).push(r); });
    for (const list of Object.values(groups)){
      list.sort((a,b)=> parseMin(a.start) - parseMin(b.start));
      let first = list[0];
      let curr = { date, solicitante:first.solicitante, atividade:first.atividade, start:first.start, end:first.end, labels:[], allSlots:(first.type==='slot') };
      if (first.type==='slot' && first.slot_label) curr.labels.push(first.slot_label);
      for (let i=1;i<list.length;i++){
        const it = list[i];
        const s = parseMin(it.start), e = parseMin(it.end);
        const ce = parseMin(curr.end);
        if (s <= ce){ // cont√≠gua/sobreposta
          if (e > ce) curr.end = it.end;
          if (it.type==='slot' && it.slot_label && !curr.labels.includes(it.slot_label)) curr.labels.push(it.slot_label);
          curr.allSlots = curr.allSlots && (it.type==='slot');
        } else {
          merged.push(curr);
          curr = { date, solicitante:it.solicitante, atividade:it.atividade, start:it.start, end:it.end, labels:[], allSlots:(it.type==='slot') };
          if (it.type==='slot' && it.slot_label) curr.labels.push(it.slot_label);
        }
      }
      merged.push(curr);
    }
  }
  return merged.sort((a,b)=> a.date===b.date ? (parseMin(a.start)-parseMin(b.start)) : a.date.localeCompare(b.date));
}

/* ===== List (m√™s) ===== */
function renderList(){
  const body=$('#reservationsBody'); body.innerHTML='';
  const merged = consolidateMonth(state.reservations);
  if(!merged.length){ body.innerHTML=`<div class="empty">Nenhuma reserva neste m√™s.</div>`; return; }
  const niceJoin = (arr)=> arr.length<=1? (arr[0]||'') : (arr.slice(0,-1).join(', ') + ' e ' + arr[arr.length-1]);
  const today = todayISO();
  merged.forEach(r=>{
    const isToday = r.date === today;
    let head = isToday ? `HOJE ‚Ä¢ ` : `${fmtBR(r.date)} ‚Ä¢ `;
    if (r.allSlots && r.labels && r.labels.length){ head += `${niceJoin(r.labels)} ${r.start}‚Äì${r.end}`; }
    else { head += `${r.start}‚Äì${r.end}`; }
    const row=document.createElement('div'); row.className='row';
    row.innerHTML = `<div class="badge ${isToday?'today':''}">${head}</div>
      <div><div><strong>Solicitante:</strong> ${esc(r.solicitante)}</div>
      <div style="margin-top:4px"><strong>Atividade:</strong> ${esc(r.atividade)}</div></div>`;
    body.appendChild(row);
  });
}

/* ===== Slots modal (multi-sele√ß√£o) ===== */
const slotsModal = $('#slotsModal'); const closeSlots = ()=> slotsModal.classList.remove('open'); $('#closeSlots').addEventListener('click', closeSlots);
function resetSelection(){ state.selections=[]; updateSelSummary(); }
function isSelected(start,end){ return state.selections.some(it=>it.start===start && it.end===end); }
function toggleSelection(item){
  const idx = state.selections.findIndex(it=>it.start===item.start && it.end===item.end);
  if(idx>=0) state.selections.splice(idx,1); else state.selections.push(item);
  updateSelSummary();
}
function updateSelSummary(){
  $('#selSummary').textContent = `${state.selections.length} hor√°rio(s) selecionado(s)`;
  $('#goReserve').disabled = state.selections.length===0;
}

function openSlotsModal(iso){
  state.selectedDay=iso; resetSelection();
  $('#slotsDateLabel').textContent=`Data: ${fmtBR(iso)}`;
  renderMorningList(); renderAfternoonGrid();
  slotsModal.classList.add('open');
  $('#clearSel').onclick = ()=>{ resetSelection(); renderMorningList(); renderAfternoonGrid(); };
  $('#goReserve').onclick = ()=>{
    const span = `${fmtBR(iso)} ‚Ä¢ ${state.selections.length} hor√°rio(s)`;
    $('#reserveMeta').textContent = span; $('#reserveCount').textContent = `${state.selections.length} hor√°rio(s) ser√£o reservados`;
    $('#reserveError').style.display='none'; $('#inpSolicitante').value=''; $('#inpAtividade').value='';
    reserveModal.classList.add('open'); setTimeout(()=>$('#inpSolicitante').focus(),60);
  };
}

function renderMorningList(){
  const iso=state.selectedDay; const cont=$('#morningList'); cont.innerHTML='';
  const slots=slotsForDate(iso); const taken=new Set(state.reservations.filter(r=>r.date===iso && r.type==='slot').map(r=>r.slot_key));
  slots.forEach(s=>{
    const busy = taken.has(s.slotKey);
    const selected = isSelected(s.start,s.end);
    const item=document.createElement('div'); item.className=`slot-item ${busy?'slot-busy':'slot-free'}`;
    const left=document.createElement('div'); left.innerHTML=`<div class="slot-txt">${esc(s.label)} ‚Äî ${s.start}‚Äì${s.end}</div>`;
    const right=document.createElement('div');
    const btn=document.createElement('button'); btn.className='slot-btn' + (selected?' selected':'');
    btn.textContent = selected? '‚úÖ Selecionado' : (busy?'Indispon√≠vel':'Selecionar');
    btn.disabled = busy;
    btn.addEventListener('click', ()=>{ toggleSelection({type:'slot', start:s.start, end:s.end, slot_key:s.slotKey, slot_label:s.label}); renderMorningList(); });
    right.appendChild(btn);
    item.appendChild(left); item.appendChild(right); cont.appendChild(item);
  });
}

function renderAfternoonGrid(){
  const iso=state.selectedDay; const grid=$('#afGrid'); grid.innerHTML='';
  const blocks=halfHourBlocks();
  const todays=state.reservations.filter(r=>r.date===iso);
  let freeCount=0;
  blocks.forEach(b=>{
    const busy = todays.some(r=> intervalsOverlap(parseMin(b.start),parseMin(b.end),parseMin(r.start),parseMin(r.end)));
    const selected = isSelected(b.start,b.end);
    const div=document.createElement('div'); div.className='chip ' + (busy?'busy':'free') + (selected?' selected':'');
    div.textContent = `${b.start}‚Äì${b.end}`;
    if(!busy){ div.addEventListener('click', ()=>{ toggleSelection({type:'range', start:b.start, end:b.end, slot_key:'', slot_label:'Tarde'}); renderAfternoonGrid(); }); }
    if(!busy) freeCount++;
    grid.appendChild(div);
  });
  $('#afInfo').textContent = freeCount? `${freeCount} blocos livres de 30 min` : 'Nenhum bloco livre na tarde';
}

/* ===== Reserva (batch) ===== */
const reserveModal=$('#reserveModal'); const closeReserve=()=> reserveModal.classList.remove('open'); $('#closeReserve').addEventListener('click',closeReserve);
$('#btnSalvar').addEventListener('click', async (ev)=>{
  const btn=ev.currentTarget; btn.disabled=true; btn.textContent='Salvando...';
  try{
    const solicitante=$('#inpSolicitante').value.trim(); const atividade=$('#inpAtividade').value.trim();
    if(!solicitante || !atividade){ showErr('Preencha todas as informa√ß√µes.'); return; }
    const slug=state.route.space; const iso=state.selectedDay; if(!slug||!iso||!state.selections.length){ return; }

    // valida contra reservas atuais (√∫ltimo estado)
    await swrUpdate(slug, state.month.getFullYear(), state.month.getMonth()+1); // sincroniza m√™s atual
    const todays=state.reservations.filter(r=>r.date===iso);
    const conflictLocal = state.selections.some(it=> todays.some(r=> intervalsOverlap(parseMin(it.start),parseMin(it.end),parseMin(r.start),parseMin(r.end))));
    if(conflictLocal){ showErr('Algum hor√°rio selecionado foi reservado agora h√° pouco. Reabra os hor√°rios e tente novamente.'); return; }

    const items = state.selections.map(it=> ({ type: it.type, start: it.start, end: it.end, slot_key: it.slot_key||'', slot_label: it.slot_label||'' }));
    await apiCreateBatch({ space: slug, date: iso, solicitante, atividade, items: JSON.stringify(items) });

    toast('Reservas salvas!'); reserveModal.classList.remove('open'); closeSlots();
    // Atualiza cache e tela
    const y=state.month.getFullYear(), m=state.month.getMonth()+1; await swrUpdate(slug,y,m);
    renderCalendar(); renderList();
  }catch(e){ showErr(e.message||'Falha ao salvar.'); }
  finally{ btn.disabled=false; btn.textContent='Salvar reservas'; }
});
function showErr(m){ $('#reserveError').textContent=m; $('#reserveError').style.display='block'; }
function toast(m){ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ===== API ===== */
async function apiList(space,year,month){
  const url = `${API_BASE}?space=${encodeURIComponent(space)}&year=${year}&month=${month}`;
  const res = await fetch(url, { method:'GET' });
  const data = await res.json();
  if(!res.ok || data.ok===false) throw new Error(data.message||'Erro ao carregar.');
  return data.reservations||[];
}
async function apiCreateBatch(payload){
  const params = new URLSearchParams(); Object.entries(payload).forEach(([k,v])=> params.append(k, v));
  const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' }, body: params.toString() });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok || data.ok===false){ const msg=(data&&data.message)||'Erro ao salvar.'; throw new Error(msg); }
  return data;
}

/* ===== Space view ===== */
function renderSpace(){
  const slug=state.route.space; const sp=SPACES.find(s=>s.slug===slug); if(!sp){ goHome(); return; }
  const hero = $('#spaceImg'); hero.decoding='async'; hero.loading='eager'; hero.src = sp.img; hero.onerror=function(){ this.src = `https://picsum.photos/seed/${sp.slug}/800/450`; };
  $('#spaceName').textContent=sp.name; $('#spaceSlug').textContent=`/${sp.slug}`;
  renderCalendar(); renderList(); $('#home').hidden=true; $('#spaceView').hidden=false;
}

/* ===== Root ===== */
function render(){ if(state.route.page==='home') renderHome(); else renderSpace(); }
// ===== Relat√≥rio em PDF (print) =====
function printReport(){
  const spaceSlug = state.route.space;
  const space = SPACES.find(s=>s.slug===spaceSlug);
  const month = state.month;
  const merged = consolidateMonth(state.reservations);
  const today = todayISO();
  const logoURL = new URL('assets/logo.png', location.href).href;
  const by = {};
  merged.forEach(r=>{ (by[r.date] ||= []).push(r); });
  const keys = Object.keys(by).sort();
  let totalMin = 0;
  const dur = (mins)=>{ const h=Math.floor(mins/60), m=mins%60; return h?(m?`${h}h ${m}min`:`${h}h`):`${m}min`; };
  const sections = keys.map(date=>{
    const rows = by[date].map(r=>{
      const mins = parseMin(r.end) - parseMin(r.start);
      totalMin += mins;
      const turno = r.allSlots ? 'Manh√£' : 'Tarde';
      const labels = (r.allSlots && r.labels && r.labels.length) ? r.labels.join(', ') : '‚Äî';
      return `<tr><td>${r.start}‚Äì${r.end}</td><td>${dur(mins)}</td><td>${turno}</td><td>${esc(labels)}</td><td>${esc(r.solicitante)}</td><td>${esc(r.atividade)}</td></tr>`;
    }).join('');
    const dow = new Date(date+"T00:00:00").toLocaleDateString('pt-BR', { weekday:'long' });
    const title = (date===today) ? 'HOJE' : `${fmtBR(date)} (${dow})`;
    return `<h3>${title}</h3><table class="t"><thead><tr><th>Hora</th><th>Dura√ß√£o</th><th>Turno</th><th>Aulas</th><th>Solicitante</th><th>Atividade</th></tr></thead><tbody>${rows}</tbody></table>`;
  }).join('');
  const totalDur = dur(totalMin);
  const monthName = month.toLocaleDateString('pt-BR',{ month:'long', year:'numeric' });
  const genAt = new Date().toLocaleString('pt-BR', { timeZone:'America/Recife' });
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relat√≥rio ${space?esc(space.name):''} ‚Ä¢ ${monthName}</title>
  <style>
    @page{ size: A4; margin: 14mm; }
    *{ box-sizing: border-box }
    body{ font: 12pt -apple-system,Segoe UI,Roboto,Arial; color:#111; margin:0; }
    header{ display:flex; align-items:center; gap:12px; padding-bottom:6px; border-bottom:2px solid #ddd; margin-bottom:12px }
    header img{ height:34px }
    h1{ font-size:18pt; margin:0 }
    h2{ font-size:13pt; margin:2px 0 0; color:#444 }
    .meta{ font-size:10pt; color:#555; margin:10px 0 14px }
    h3{ font-size:12.5pt; margin:18px 0 6px; color:#111 }
    table.t{ width:100%; border-collapse:collapse; margin:4px 0 10px }
    .t th,.t td{ border:1px solid #ddd; padding:6px 8px; vertical-align:top }
    .t thead th{ background:#f3f4f6; text-align:left }
    .t tbody tr:nth-child(even){ background:#fafafa }
    footer{ margin-top:12px; font-size:10pt; color:#666; border-top:1px solid #eee; padding-top:6px }
    @media print{ .page-break{ page-break-before: always } }
  </style>
  </head><body>
    <header>
      <img src="${logoURL}" alt="IAPE" />
      <div>
        <h1>Relat√≥rio de Reservas</h1>
        <h2>${space?esc(space.name):''} ‚Ä¢ ${monthName}</h2>
      </div>
    </header>
    <div class="meta">Gerado em ${genAt}. Total de reservas: ${merged.length}. Tempo total de uso: ${totalDur}.</div>
    ${sections || '<p>N√£o h√° reservas neste m√™s.</p>'}
    <footer>Fonte: IAPE Agendamento ‚Äî gerado em ${genAt}</footer>
    <script>window.onload=function(){ setTimeout(function(){ window.print(); }, 60); }<\/script>
  </body></html>`;
  const w = window.open('', '_blank');
  if(!w){ alert('Bloqueador de pop-up ativo. Permita abrir nova aba para imprimir.'); return; }
  w.document.write(html); w.document.close();
}

document.getElementById('printReportBtn')?.addEventListener('click', printReport);

function boot(){
  updateLogoForTheme();
  renderHome();
  $$('#spaceView .back').forEach(el=> el.addEventListener('click', e=>{ e.preventDefault(); location.hash=''; }));
  const h=new URLSearchParams(location.hash.slice(1)); if(h.get('space')) goSpace(h.get('space')); else goHome();
}
boot();
</script>
</body>
</html>

